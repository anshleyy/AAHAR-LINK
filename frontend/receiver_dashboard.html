<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Receiver Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .sidebar {
        width: 250px;
        background-color: #0b464a;
      }
      .bg-opacity {
        background-color: rgba(1, 73, 78, 0.6);
      }
      .notification-bell {
        position: absolute;
        right: 70px;
        cursor: pointer;
        font-size: 24px;
      }
      .notification-item {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .notification-item:hover {
        background-color: #f8f8f8;
      }
      .notification-item.unread {
        background-color: #e0c1a3;
      }
      .notification-item.unread:hover {
        background-color: #d4b494;
      }
      .notification-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: red;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        min-width: 18px;
        text-align: center;
      }
      .replies-section {
        margin-top: 20px;
        padding: 10px;
        background: #f6e6d8;
        border-radius: 8px;
      }
      .reply-item {
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 5px;
      }
      .reply-item.agent {
        background: #e0c1a3;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
      }

      .donor-info {
        margin: 20px 0;
      }

      .donor-info p {
        margin: 10px 0;
      }

      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }

      .rating-container {
        text-align: center;
        margin: 20px 0;
      }

      .rating-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .rating-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #ddd;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .rating-btn.selected {
        background-color: #4caf50;
        color: white;
        border-color: #4caf50;
      }

      .rating-label {
        color: #666;
        font-size: 0.9em;
      }

      .comment-container {
        margin: 20px 0;
      }

      #commentTextarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
      }

      .notification-item {
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s;
      }

      .notification-item:last-child {
        border-bottom: none;
      }

      .notification-item:hover {
        background-color: #f3f4f6;
      }

      .notification-item.unread {
        background-color: #e0c1a3;
      }

      .notification-item.unread:hover {
        background-color: #d4b494;
      }

      /* Update notification dropdown styles */
      .notification-bell-container {
        position: relative;
        display: inline-block;
      }

      .notification-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        width: 320px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 0.5rem;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 1000;
      }

      .notification-dropdown.hidden {
        display: none !important;
      }

      .notification-item {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .notification-item:last-child {
        border-bottom: none;
      }

      .notification-item:hover {
        background-color: #f3f4f6;
      }

      .notification-item.unread {
        background-color: #e0c1a3;
      }

      .notification-item.unread:hover {
        background-color: #d4b494;
      }

      #notification-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: red;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        min-width: 18px;
        text-align: center;
      }

      #notification-count.hidden {
        display: none;
      }
    </style>
  </head>
  <body class="flex bg-opacity text-white">
    <!-- Sidebar -->
    <aside class="sidebar text-white p-5 min-h-screen">
      <h2 class="text-3xl font-bold">Aahar Link</h2>
      <p class="text-sm mb-5">Receiver Portal</p>
      <nav>
        <ul>
          <li class="py-2"><a href="#" class="block">üè† Dashboard</a></li>
          <li class="py-2"><a href="#" class="block">üì¶ Requested Items</a></li>
          <li class="py-2"><a href="#" class="block">‚öôÔ∏è Settings</a></li>
          <!-- Logout Button -->
          <li class="py-52 mt-4"></li>
          <div class="mt-auto flex justify-center pb-4">
            <button
              id="logout-btn"
              class="bg-blue-500 text-white px-4 py-2 rounded w-32"
            >
              Logout
            </button>
          </div>
        </ul>
      </nav>
    </aside>

    <script>
      document
        .getElementById("logout-btn")
        .addEventListener("click", function () {
          if (confirm("Are you sure you want to log out?")) {
            localStorage.removeItem("receiverId");
            localStorage.removeItem("receiverDetails");
            window.location.href = "/receiver_login.html";
          }
        });
    </script>

    <!-- Main Content -->
    <main class="flex-1 p-6">
      <header class="flex justify-between items-center mb-5">
        <h1 class="text-2xl font-bold">Receiver Dashboard</h1>
        <div class="flex items-center gap-4">
          <div class="notification-bell-container">
            <div
              class="relative text-red-500 text-xl cursor-pointer"
              id="notification-btn"
            >
              üîî
              <span id="notification-count" class="hidden">0</span>
            </div>
            <div
              id="notification-dropdown"
              class="notification-dropdown hidden"
            >
              <div id="notification-list" class="divide-y divide-gray-200">
                <!-- Notifications will be loaded here -->
              </div>
            </div>
          </div>

          <button
            id="raise-complaint-btn"
            class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-red-700 transition"
          >
            üìù Raise Complaint
          </button>
          <span class="bg-[#0B464A] text-white px-3 py-1 rounded-full">R</span>
        </div>
      </header>

      <!-- Receiver Details Section -->
      <div class="bg-white p-4 rounded-lg shadow-md mt-5 text-black">
        <h2 class="text-xl font-bold mb-3">Receiver Details</h2>
        <p>
          <strong>Name of NPO:</strong> <span id="npo-name">Loading...</span>
        </p>
        <!-- Default address set to "Verify First" -->
        <p>
          <strong>Address:</strong> <span id="npo-address">Verify First</span>
        </p>

        <!-- Verification Button -->
        <button
          id="verifyNow"
          class="w-full mt-3 bg-[#0B464A] text-white py-2 rounded"
        >
          Verify Now
        </button>
      </div>

      <!-- Available Food Listings -->
      <div class="bg-white p-4 rounded-lg shadow-md mt-5 text-black">
        <h2 class="text-xl font-bold mb-3">Available Food Listings</h2>
        <table id="food-listings" class="w-full text-left border-collapse">
          <thead>
            <tr>
              <th class="border-b p-2">Title</th>
              <th class="border-b p-2">Type</th>
              <th class="border-b p-2">Quantity</th>
              <th class="border-b p-2">Expiry Date</th>
              <th class="border-b p-2">Restaurant</th>
              <th class="border-b p-2">Status</th>
              <th class="border-b p-2">Request</th>
            </tr>
          </thead>
          <tbody>
            <!-- Listings will be dynamically inserted here -->
          </tbody>
        </table>
      </div>

      <!-- Requested Food Section -->
      <div class="bg-white p-4 rounded-lg shadow-md mt-5 text-black">
        <h2 class="text-xl font-bold mb-3">Your Requests</h2>
        <table id="request-list" class="w-full text-left border-collapse">
          <thead>
            <tr>
              <th class="border-b p-2">Food Item</th>
              <th class="border-b p-2">Restaurant</th>
              <th class="border-b p-2">Status</th>
              <th class="border-b p-2">Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Requests will be dynamically inserted here -->
          </tbody>
        </table>
      </div>
    </main>

    <!-- Complaint Modal -->
    <div
      id="complaint-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"
    >
      <div class="bg-white text-black rounded-lg p-6 w-full max-w-md shadow-xl">
        <h2 class="text-xl font-bold mb-4">Raise a Complaint</h2>
        <label class="block mb-2">Title</label>
        <input
          type="text"
          id="complaint-title"
          class="w-full border border-gray-300 rounded p-2 mb-4"
          placeholder="Enter title..."
        />
        <label class="block mb-2">Description</label>
        <textarea
          id="complaint-desc"
          class="w-full border border-gray-300 rounded p-2 mb-4"
          rows="4"
          placeholder="Describe your issue..."
        ></textarea>
        <p class="text-sm text-gray-600 mb-4">
          Ticket Number: <span id="ticket-id" class="font-bold"></span>
        </p>
        <div class="flex justify-end gap-2">
          <button
            id="cancel-complaint"
            class="px-4 py-2 rounded bg-gray-400 text-white"
          >
            Cancel
          </button>
          <button
            id="submit-complaint"
            class="px-4 py-2 rounded bg-[#0B464A] text-white hover:bg-blue-700"
          >
            Submit
          </button>
        </div>
      </div>
    </div>

    <!-- Include receiver.js for handling verification and other functions -->
    <script>
      // Function to fetch food listings from the API
      async function fetchFoodListings() {
        try {
          const response = await fetch("/api/donations/active");
          if (!response.ok) {
            throw new Error("Failed to fetch food listings");
          }
          const listings = await response.json();
          console.log("Received food listings:", listings); // Debug log

          const tableBody = document.querySelector("#food-listings tbody");
          if (!tableBody) {
            console.error("Food listings table body not found");
            return;
          }

          tableBody.innerHTML = "";

          if (!Array.isArray(listings) || listings.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="p-2 text-gray-500 text-center">
                  No food listings available
                </td>
              </tr>
            `;
            return;
          }

          listings.forEach((listing) => {
            const donorName =
              listing.donorId?.companyname ||
              listing.donorId?.name ||
              listing.donorId?.nponame ||
              "Unknown Restaurant";

            const row = document.createElement("tr");
            row.innerHTML = `
          <td class="p-2">${listing.title}</td>
          <td class="p-2 ${
            listing.type === "veg" ? "text-green-500" : "text-red-500"
          }">${listing.type}</td>
          <td class="p-2">${listing.quantity}</td>
              <td class="p-2">${new Date(
                listing.expiryDate
              ).toLocaleDateString()}</td>
              <td class="p-2">${donorName}</td>
              <td class="p-2 ${
                listing.status === "Active"
                  ? "text-green-500"
                  : listing.status === "Expired"
                  ? "text-red-500"
                  : listing.status === "Claimed"
                  ? "text-yellow-500"
                  : listing.status === "Confirmed"
                  ? "text-blue-500"
                  : "text-gray-500"
              }">${listing.status}</td>
          <td class="p-2">
              ${
                listing.status === "Active"
                  ? `
                <button 
                  class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600"
                  onclick="sendFoodRequest('${listing._id}')"
                >
                  Request
                </button>
              `
                  : ""
              }
          </td>
        `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("Error fetching listings:", error);
          const tableBody = document.querySelector("#food-listings tbody");
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="p-2 text-red-500 text-center">
                  Failed to load food listings. Please try again.
                </td>
              </tr>
            `;
          }
        }
      }

      // Function to fetch and display receiver details
      async function fetchReceiverDetails() {
        const nponame = localStorage.getItem("receivernponame");
        if (!nponame) {
          console.error("NPO name not found in localStorage");
          return;
        }

        try {
          const response = await fetch(`${baseUrl}/api/receiver/details`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ nponame }),
          });

          const data = await response.json();
          if (data.success) {
            // Store receiverId in localStorage
            if (data._id) {
              localStorage.setItem("receiverId", data._id);
            }

            // Store receiver details in localStorage for persistence
            localStorage.setItem(
              "receiverDetails",
              JSON.stringify({
                nponame: data.nponame,
                address: data.address,
                verified: data.verified,
              })
            );

            // Update UI with receiver details
            document.getElementById("npo-name").textContent = data.nponame;
            document.getElementById("npo-address").textContent = data.verified
              ? data.address
              : "Verify First";

            // Update verification button
            const verifyBtn = document.getElementById("verifyNow");
            if (verifyBtn) {
              verifyBtn.textContent = data.verified
                ? "Verified ‚úÖ"
                : "Verify Now";
              verifyBtn.disabled = data.verified;
            }

            // Refresh requests and notifications after getting fresh data
            await Promise.all([fetchReceiverRequests(), loadNotifications()]);
          } else {
            console.error("Failed to fetch receiver details:", data.message);
            // Try to use cached data if fetch fails
            const cachedDetails = localStorage.getItem("receiverDetails");
            if (cachedDetails) {
              const cachedData = JSON.parse(cachedDetails);
              document.getElementById("npo-name").textContent =
                cachedData.nponame;
              document.getElementById("npo-address").textContent =
                cachedData.verified ? cachedData.address : "Verify First";
            }
          }
        } catch (error) {
          console.error("Error fetching receiver details:", error);
          // Try to use cached data if fetch fails
          const cachedDetails = localStorage.getItem("receiverDetails");
          if (cachedDetails) {
            const cachedData = JSON.parse(cachedDetails);
            document.getElementById("npo-name").textContent =
              cachedData.nponame;
            document.getElementById("npo-address").textContent =
              cachedData.verified ? cachedData.address : "Verify First";
          }
        }
      }

      // Function to fetch and store receiver ID
      async function fetchAndStoreReceiverId() {
        try {
          const nponame = localStorage.getItem("receivernponame");
          if (!nponame) {
            console.error("No NPO name found in localStorage");
            return;
          }

          const response = await fetch(`${baseUrl}/api/receiver/details`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ nponame }),
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Received data for ID:", data); // Debug log

          if (data.success) {
            // Store the receiver ID in localStorage
            if (data._id) {
              localStorage.setItem("receiverId", data._id);
              console.log("Stored receiverId:", data._id); // Debug log
            } else if (data.Receiver && data.Receiver._id) {
              localStorage.setItem("receiverId", data.Receiver._id);
              console.log(
                "Stored receiverId from Receiver object:",
                data.Receiver._id
              ); // Debug log
            } else if (data.receiverId) {
              localStorage.setItem("receiverId", data.receiverId);
              console.log(
                "Stored receiverId from receiverId field:",
                data.receiverId
              ); // Debug log
            }
          }
        } catch (error) {
          console.error("Error fetching receiver ID:", error);
        }
      }

      // Function to send food request
      async function sendFoodRequest(donationId) {
        try {
          // Get receiver ID from localStorage
          let receiverId = localStorage.getItem("receiverId");
          console.log("Current receiverId from localStorage:", receiverId); // Debug log

          // If no receiverId, try to fetch it first
          if (!receiverId) {
            console.log("No receiverId found, fetching ID..."); // Debug log
            await fetchAndStoreReceiverId();
            receiverId = localStorage.getItem("receiverId");
            console.log("New receiverId after fetch:", receiverId); // Debug log

            if (!receiverId) {
              throw new Error("Please log in again. No receiver ID found.");
            }
          }

          // Validate receiver ID
          if (
            !receiverId ||
            receiverId === "undefined" ||
            receiverId === "null"
          ) {
            console.error("Invalid receiver ID format:", receiverId);
            throw new Error("Invalid receiver ID. Please log in again.");
          }

          // Make the request
          const response = await fetch(`/api/donations/request/${donationId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              receiverId: receiverId,
              status: "Claimed", // Explicitly set status to Claimed
            }),
            credentials: "include",
          });

          // Handle response
          if (!response.ok) {
            const errorData = await response.json();
            console.error("Request error response:", errorData); // Debug log
            throw new Error(errorData.message || "Failed to send request");
          }

          const data = await response.json();
          console.log("Request successful response:", data); // Debug log

          if (data.success) {
            alert("Request sent successfully!");
            // Refresh both the food listings and requests list
            await Promise.all([fetchFoodListings(), fetchReceiverRequests()]);
          } else {
            throw new Error(data.message || "Failed to send request");
          }
        } catch (error) {
          console.error("Error sending request:", error);
          alert(error.message || "Failed to send request. Please try again.");
        }
      }

      // Function to check for new notifications
      async function checkNotifications() {
        try {
          const response = await fetch("/api/notifications", {
            credentials: "include",
          });
          const notifications = await response.json();

          const notificationCount =
            document.getElementById("notification-count");
          const notificationDropdown = document.getElementById(
            "notification-dropdown"
          );

          notificationCount.textContent = notifications.length;

          if (notifications.length > 0) {
            notificationDropdown.innerHTML = notifications
              .map(
                (notification) => `
            <div class="border-b border-gray-200 py-2 text-black">
              <p class="font-bold">${notification.title}</p>
              <p class="text-sm text-gray-600">${notification.message}</p>
              <p class="text-xs text-gray-400">${new Date(
                notification.createdAt
              ).toLocaleString()}</p>
            </div>
          `
              )
              .join("");

            // Check for donation approval notifications
            notifications.forEach((notification) => {
              if (notification.title === "Donation Approved") {
                // Update the status in the requests list
                const requestRows = document.querySelectorAll(
                  "#request-list tbody tr"
                );
                requestRows.forEach((row) => {
                  const collectBtn = row.querySelector(".collect-btn");
                  if (
                    collectBtn &&
                    collectBtn.dataset.id === notification.donationId
                  ) {
                    // Update status to Confirmed
                    const statusCell = row.querySelector("td:nth-child(3)");
                    statusCell.textContent = "Confirmed";
                    statusCell.className = "p-2 text-green-500";

                    // Show collect button
                    collectBtn.classList.remove("hidden");
                  }
                });
              }
            });
          } else {
            notificationDropdown.innerHTML =
              '<p class="text-gray-500">No new notifications</p>';
          }
        } catch (error) {
          console.error("Error checking notifications:", error);
        }
      }

      // Function to fetch receiver's requests
      async function fetchReceiverRequests() {
        try {
          const receiverId = localStorage.getItem("receiverId");
          console.log("Fetching requests for receiver:", receiverId); // Debug log

          if (!receiverId) {
            console.error("No receiver ID found in localStorage");
            return;
          }

          const cleanReceiverId = receiverId.toString().trim();
          console.log("Cleaned receiverId:", cleanReceiverId); // Debug log

          const response = await fetch(
            `/api/donations/receiver-requests?receiverId=${cleanReceiverId}`,
            {
              credentials: "include",
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            console.error("Server error response:", errorData);
            return;
          }

          const requests = await response.json();
          console.log("Received requests:", requests);

          if (!Array.isArray(requests)) {
            console.error("Invalid response format:", requests);
            return;
          }

          const requestList = document.querySelector("#request-list tbody");
          if (!requestList) {
            console.error("Request list table not found");
            return;
          }

          requestList.innerHTML = "";

          if (requests.length === 0) {
            requestList.innerHTML = `
              <tr>
                <td colspan="4" class="p-2 text-gray-500 text-center">
                  No requests found
                </td>
              </tr>
            `;
            return;
          }

          requests.forEach((request) => {
            const row = document.createElement("tr");
            const statusColor =
              request.status === "Pending"
                ? "text-yellow-500"
                : request.status === "Confirmed"
                ? "text-green-500"
                : request.status === "Claimed"
                ? "text-yellow-500"
                : "text-gray-500";

            const donorName =
              request.donorId?.companyname ||
              request.donorId?.name ||
              "Unknown Restaurant";

            row.innerHTML = `
              <td class="p-2">${request.title}</td>
              <td class="p-2">${donorName}</td>
              <td class="p-2 ${statusColor}">${request.status}</td>
              <td class="p-2">
                ${
                  request.status === "Confirmed"
                    ? `
                  <button class="bg-green-500 text-white px-2 py-1 rounded collect-btn" 
                    data-id="${request._id}">
                    Collect
                  </button>
                `
                    : ""
                }
              </td>
      `;
            requestList.appendChild(row);
          });

          // Add event listeners to collect buttons
          document.querySelectorAll(".collect-btn").forEach((button) => {
            button.addEventListener("click", function () {
              markAsCollected(this.dataset.id);
            });
          });
        } catch (error) {
          console.error("Error fetching requests:", error);
        }
      }

      // Function to update the UI with receiver details
      function updateReceiverUI(data) {
        console.log("Updating UI with data:", data); // Debug log

        const npoNameElement = document.getElementById("npo-name");
        const npoAddressElement = document.getElementById("npo-address");
        const verifyBtn = document.getElementById("verifyNow");

        if (npoNameElement) {
          npoNameElement.textContent =
            data.nponame || data.Receiver?.nponame || "Unknown NPO";
        }

        if (npoAddressElement) {
          npoAddressElement.textContent =
            data.address || data.Receiver?.address || "Verify First";
        }

        if (verifyBtn) {
          const isVerified = data.verified || data.Receiver?.verified;
          if (isVerified) {
            verifyBtn.innerText = "Verified ‚úÖ";
            verifyBtn.disabled = true;
            verifyBtn.classList.add("bg-[#0B464A]");
          } else {
            verifyBtn.innerText = "Verify Now";
            verifyBtn.disabled = false;
            verifyBtn.classList.remove("bg-[#0B464A]");
            verifyBtn.classList.add(
              "bg-[#0B464A]",
              "hover:bg-[#0B464A]/90",
              "text-white",
              "px-4",
              "py-2",
              "rounded"
            );
          }
        }
      }

      // Initialize the dashboard
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("DOM Content Loaded"); // Debug log

        // First try to use cached data
        const cachedDetails = localStorage.getItem("receiverDetails");
        if (cachedDetails) {
          const cachedData = JSON.parse(cachedDetails);
          document.getElementById("npo-name").textContent = cachedData.nponame;
          document.getElementById("npo-address").textContent =
            cachedData.verified ? cachedData.address : "Verify First";
        }

        // Then fetch fresh data
        await Promise.all([
          fetchReceiverDetails(),
          fetchFoodListings(),
          loadNotifications(),
        ]);

        // Set up periodic refresh
        setInterval(async () => {
          await Promise.all([
            fetchReceiverDetails(),
            fetchFoodListings(),
            loadNotifications(),
          ]);
        }, 30000); // Refresh every 30 seconds
      });

      // Update verification button click handler
      document
        .getElementById("verifyNow")
        .addEventListener("click", async function () {
          try {
            const nponame = localStorage.getItem("receivernponame");
            console.log("Current nponame:", nponame); // Debug log

            if (!nponame) {
              throw new Error("NPO name not found. Please log in again.");
            }

            // Show verifying status
            this.innerText = "Verifying...";
            this.disabled = true;

            // First fetch the receiver details to get the registration number
            const response = await fetch(`${baseUrl}/api/receiver/details`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ nponame }),
              credentials: "include",
            });

            if (!response.ok) {
              const errorData = await response.json();
              console.error("Error response:", errorData); // Debug log
              throw new Error(
                errorData.message || "Failed to fetch receiver details"
              );
            }

            const data = await response.json();
            console.log("Full response data:", data); // Debug log

            if (!data.success) {
              throw new Error(
                data.message || "Failed to fetch receiver details"
              );
            }

            // Get the registration number from the session data
            const regno = data.regno;
            console.log("Found registration number:", regno); // Debug log

            if (!regno) {
              throw new Error("Registration number not found for this NPO");
            }

            // Call verifyNgo function with the registration number
            const verifyResponse = await fetch(
              `${baseUrl}/api/receiver/verify`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify({
                  nponame: nponame,
                  regno: regno,
                }),
              }
            );

            const verifyData = await verifyResponse.json();
            console.log("Verification response:", verifyData); // Debug log

            if (verifyResponse.ok && verifyData.success) {
              alert("Verification successful!");
              // Update the UI to show verified status
              this.innerText = "Verified ‚úÖ";
              this.disabled = true;
              this.classList.add("bg-[#0B464A]");

              // Update address if provided
              if (verifyData.address) {
                document.getElementById("npo-address").textContent =
                  verifyData.address;
              }

              // Refresh receiver details
              fetchReceiverDetails();
            } else {
              alert("Verification failed");
              // Reset button state
              this.innerText = "Verify Now";
              this.disabled = false;
            }
          } catch (error) {
            console.error("Error during verification:", error);
            alert(error.message || "Verification failed. Please try again.");
            // Reset button state
            this.innerText = "Verify Now";
            this.disabled = false;
          }
        });
    </script>

    <!-- Common variables -->
    <script>
      // Define baseUrl at the top level to be used by all scripts
      const baseUrl = window.location.origin;
    </script>

    <!-- Donor Details Modal -->
    <div
      id="donor-details-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"
    >
      <div class="bg-white text-black rounded-lg p-6 w-full max-w-md shadow-xl">
        <h2 class="text-xl font-bold mb-4">Collect Your Food</h2>

        <div class="mb-4">
          <p class="font-bold">
            Food Item: <span id="donation-title" class="font-normal"></span>
          </p>
          <p class="font-bold">
            Donor Name: <span id="donor-name" class="font-normal"></span>
          </p>
          <p class="font-bold">
            Pickup Address: <span id="donor-address" class="font-normal"></span>
          </p>
        </div>

        <div class="bg-yellow-100 p-3 rounded mb-4">
          <p class="text-yellow-800">
            Please collect your food from the above address. Make sure to bring
            a valid ID for verification.
          </p>
        </div>

        <div class="flex justify-end gap-2">
          <button
            id="cancel-collection"
            class="px-4 py-2 rounded bg-gray-400 text-white"
          >
            Cancel
          </button>
          <button
            id="confirm-collection"
            class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700"
          >
            Confirm Collection
          </button>
        </div>
      </div>
    </div>

    <!-- Complaint Modal Logic-->
    <script>
      // Get complaint modal elements
      const complaintModal = document.getElementById("complaint-modal");
      const raiseComplaintBtn = document.getElementById("raise-complaint-btn");
      const cancelComplaintBtn = document.getElementById("cancel-complaint");
      const submitComplaintBtn = document.getElementById("submit-complaint");
      const ticketIdSpan = document.getElementById("ticket-id");

      // Function to generate random ticket number
      function generateTicketNumber() {
        return "#" + Math.floor(Math.random() * 90000 + 10000);
      }

      // Function to reset and open complaint modal
      function openComplaintModal() {
        const ticketNumber = generateTicketNumber();
        ticketIdSpan.textContent = ticketNumber;
        document.getElementById("complaint-title").value = "";
        document.getElementById("complaint-desc").value = "";
        complaintModal.classList.remove("hidden");
      }

      // Function to close complaint modal
      function closeComplaintModal() {
        complaintModal.classList.add("hidden");
      }

      // Event Listeners
      if (raiseComplaintBtn) {
        raiseComplaintBtn.addEventListener("click", openComplaintModal);
      }

      if (cancelComplaintBtn) {
        cancelComplaintBtn.addEventListener("click", closeComplaintModal);
      }

      if (submitComplaintBtn) {
        submitComplaintBtn.addEventListener("click", async () => {
          const title = document.getElementById("complaint-title").value.trim();
          const desc = document.getElementById("complaint-desc").value.trim();
          const ticketId = ticketIdSpan.textContent;

          if (!title || !desc) {
            alert("Please fill in all fields.");
            return;
          }

          const complaintData = {
            ticketId,
            title,
            description: desc,
            createdAt: new Date().toISOString(),
          };

          try {
            const response = await fetch(`${baseUrl}/api/complaints/raise`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify(complaintData),
            });

            const data = await response.json();
            if (data.success) {
              alert(`Complaint submitted! Your ticket number is ${ticketId}`);
              closeComplaintModal();
              // Refresh notifications to show the new complaint
              if (typeof loadNotifications === "function") {
                loadNotifications();
              }
            } else {
              alert(
                "Failed to submit complaint: " +
                  (data.message || "Please try again.")
              );
            }
          } catch (err) {
            console.error("Error submitting complaint:", err);
            alert("Something went wrong. Please try again.");
          }
        });
      }
    </script>

    <!-- Notification handling script -->
    <script>
      // Function to show complaint modal
      function showComplaintModal(complaint) {
        // Remove any existing modal
        const existingModal = document.querySelector(".complaint-modal");
        if (existingModal) {
          existingModal.remove();
        }

        const modal = document.createElement("div");
        modal.className =
          "complaint-modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50";
        modal.innerHTML = `
          <div class="bg-white text-black rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 flex-none border-b">
              <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Ticket #${complaint.ticketId}</h3>
                <button onclick="this.closest('.complaint-modal').remove()" class="text-gray-500 hover:text-gray-700">‚úï</button>
              </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
              <div class="mb-4">
                <p class="mb-2"><strong>Status:</strong> <span class="px-2 py-1 rounded ${
                  complaint.status === "Open"
                    ? "bg-green-100 text-green-800"
                    : "bg-red-100 text-red-800"
                }">${complaint.status}</span></p>
                <p class="mb-2"><strong>Title:</strong> ${complaint.title}</p>
                <p class="mb-4"><strong>Description:</strong> ${
                  complaint.description
                }</p>
              </div>
              <div class="space-y-4">
                <h4 class="font-bold text-lg">Conversation History</h4>
                <div class="space-y-3">
                  ${complaint.replies
                    .map(
                      (reply) => `
                    <div class="reply-item ${
                      reply.sender === "agent"
                        ? "bg-blue-50 ml-4"
                        : "bg-gray-50"
                    } p-4 rounded-lg">
                      <div class="flex justify-between items-start mb-2">
                        <span class="font-medium">${
                          reply.sender === "agent" ? "Customer Support" : "You"
                        }</span>
                        <span class="text-sm text-gray-500">${new Date(
                          reply.timestamp
                        ).toLocaleString()}</span>
                      </div>
                      <p class="text-gray-700">${reply.message}</p>
                    </div>
                  `
                    )
                    .join("")}
                </div>
              </div>
            </div>
            ${
              complaint.status === "Open"
                ? `
              <div class="p-6 flex-none border-t bg-gray-50">
                <h4 class="font-bold mb-2">Your Reply</h4>
                <textarea 
                  id="reply-text" 
                  rows="3" 
                  class="w-full border rounded p-2 mb-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" 
                  placeholder="Type your reply here..."
                ></textarea>
                <div class="flex justify-end">
                  <button 
                    onclick="submitReply('${complaint._id}')" 
                    class="bg-[#0B464A] text-white px-4 py-2 rounded hover:bg-[#0B464A]/90 transition-colors"
                  >
                    Send Reply
                  </button>
                </div>
              </div>
            `
                : `
              <div class="p-4 bg-gray-100 text-center text-gray-600">
                This complaint has been closed and cannot receive new replies
              </div>
            `
            }
          </div>
        `;
        document.body.appendChild(modal);
      }

      // Function to submit reply
      async function submitReply(complaintId) {
        const replyText = document.getElementById("reply-text").value.trim();
        if (!replyText) {
          alert("Please enter a reply message");
          return;
        }

        try {
          const response = await fetch(
            `${baseUrl}/api/complaints/update/${complaintId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify({
                reply: replyText,
                sender: "user",
              }),
            }
          );

          const data = await response.json();
          if (data.success) {
            // Refresh the complaint modal with updated data
            const complaintResponse = await fetch(
              `${baseUrl}/api/complaints/all`,
              {
                credentials: "include",
              }
            );
            const complaintsData = await complaintResponse.json();

            if (complaintsData.success) {
              const updatedComplaint = complaintsData.complaints.find(
                (c) => c._id === complaintId
              );
              if (updatedComplaint) {
                showComplaintModal(updatedComplaint);
              }
            }

            // Clear the reply text
            document.getElementById("reply-text").value = "";
          } else {
            alert(data.message || "Failed to submit reply");
          }
        } catch (error) {
          console.error("Error submitting reply:", error);
          alert("Failed to submit reply. Please try again.");
        }
      }
      //Function to update Notifications
      function updateNotificationUI(notifications, errorMessage = null) {
        const listEl = document.getElementById("notification-list");
        const badgeEl = document.getElementById("notification-count");

        // Clear / show error
        if (errorMessage) {
          listEl.innerHTML = `<p class="p-2 text-red-500">${errorMessage}</p>`;
        } else if (notifications.length === 0) {
          listEl.innerHTML = `<p class="p-2 text-gray-500">No notifications</p>`;
        } else {
          listEl.innerHTML = notifications
            .map(
              (n) => `
        <div class="notification-item ${
          n.read ? "" : "unread"
        } flex justify-between items-start p-2 cursor-pointer"
             onclick="handleNotificationClick('${n._id}','${n.ticketId}')">
          <div>
            <p class="text-gray-900">${n.message}</p>
            <small class="text-gray-500">${new Date(
              n.timestamp
            ).toLocaleString()}</small>
          </div>
          ${
            n.read
              ? ""
              : '<span class="inline-block w-2 h-2 bg-red-500 rounded-full mt-1"></span>'
          }
        </div>
      `
            )
            .join("");
        }

        // Update badge count
        const unreadCount = notifications.filter((n) => !n.read).length;
        if (badgeEl) {
          badgeEl.textContent = unreadCount;
          badgeEl.classList.toggle("hidden", unreadCount === 0);
        }
      }
      // Function to load notifications
      async function loadNotifications() {
        try {
          console.log("Loading notifications...");
          const receiverId = localStorage.getItem("receiverId");
          const nponame = localStorage.getItem("receivernponame");

          if (!receiverId || !nponame) {
            console.error("No receiver ID or NPO name found in localStorage");
            updateNotificationUI([], "Please log in to view notifications");
            return;
          }

          let allNotifications = [];

          try {
            // Fetch complaints and support replies first
            const complaintsResponse = await fetch(
              `${baseUrl}/api/complaints/all`,
              {
                method: "GET",
                credentials: "include",
              }
            );

            if (complaintsResponse.ok) {
              const complaintsData = await complaintsResponse.json();
              console.log("Complaints data:", complaintsData);

              // Add support replies as notifications
              if (
                complaintsData.success &&
                Array.isArray(complaintsData.complaints)
              ) {
                const supportReplies = complaintsData.complaints
                  .filter(
                    (c) =>
                      c.userType === "receiver" &&
                      // if userId is an ObjectId, compare strings:
                      (c.userId._id || c.userId).toString() === receiverId
                  )
                  .flatMap((complaint) =>
                    complaint.replies
                      .filter((reply) => reply.sender === "agent")
                      .map((reply) => ({
                        _id: reply._id,
                        message: `Support replied to ticket #${complaint.ticketId}: ${reply.message}`,
                        timestamp: reply.timestamp,
                        read: false,
                        ticketId: complaint.ticketId,
                      }))
                  );

                allNotifications = allNotifications.concat(supportReplies);
              }
            }
          } catch (error) {
            console.error("Error fetching complaints:", error);
          }
          // Sort notifications by timestamp (newest first)
          allNotifications.sort(
            (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
          );

          // Update the notification UI
          updateNotificationUI(allNotifications);

          // Update notification count badge
          const unreadCount = allNotifications.filter((n) => !n.read).length;
          const notificationCount =
            document.getElementById("notification-count");
          if (notificationCount) {
            notificationCount.textContent = unreadCount;
            notificationCount.classList.toggle("hidden", unreadCount === 0);
          }
        } catch (error) {
          console.error("Error loading notifications:", error);
          updateNotificationUI([], "Failed to load notifications");
        }
      }
      const bellBtn = document.getElementById("notification-btn");
      const dropdown = document.getElementById("notification-dropdown");

      bellBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("hidden");
        if (!dropdown.classList.contains("hidden")) {
          loadNotifications();
        }
      });

      // close when clicking anywhere else
      document.addEventListener("click", () => {
        dropdown.classList.add("hidden");
      });

      // Update handleNotificationClick function
      async function handleNotificationClick(notificationId, ticketId) {
        try {
          if (!notificationId || !ticketId) {
            console.error("Missing notification or ticket ID");
            return;
          }

          // Fetch the complaint details
          const response = await fetch(`${baseUrl}/api/complaints/all`, {
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error("Failed to fetch complaint details");
          }

          const data = await response.json();
          if (data.success) {
            const complaint = data.complaints.find(
              (c) => c.ticketId === ticketId
            );
            if (complaint) {
              // Show the complaint modal
              showComplaintModal(complaint);

              // Mark notification as read
              try {
                await fetch(
                  `${baseUrl}/api/complaints/notifications/${notificationId}/read`,
                  {
                    method: "PUT",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    credentials: "include",
                  }
                );

                // Refresh notifications to update read status
                await loadNotifications();
              } catch (error) {
                console.error("Error marking notification as read:", error);
              }
            } else {
              console.error("Complaint not found:", ticketId);
            }
          }
        } catch (error) {
          console.error("Error handling notification click:", error);
          alert("Failed to load complaint details. Please try again.");
        }
      }
    </script>
    <script>
      // Function to mark donation as collected and show review modal
      async function markAsCollected(donationId) {
        try {
          // First fetch donation details to get donor info
          const response = await fetch(`/api/donations/${donationId}`);
          if (!response.ok) {
            throw new Error("Failed to fetch donation details");
          }
          const donation = await response.json();

          // Show donor details modal
          const donorDetailsModal = document.getElementById(
            "donor-details-modal"
          );
          const foodTitle = document.getElementById("donation-title");
          const donorName = document.getElementById("donor-name");
          const pickupAddress = document.getElementById("donor-address");

          // Get donor details from the populated donorId field
          const donorDetails = donation.donorId;

          foodTitle.textContent = donation.title;
          donorName.textContent =
            donorDetails.companyname || donorDetails.name || "Unknown Donor";
          pickupAddress.textContent =
            donorDetails.address || "Address not available";

          donorDetailsModal.classList.remove("hidden");

          // Handle confirm collection
          document.getElementById("confirm-collection").onclick = async () => {
            try {
              const collectResponse = await fetch(
                `/api/donations/collect/${donationId}`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                }
              );

              if (!collectResponse.ok) {
                const errorData = await collectResponse.json();
                throw new Error(
                  errorData.message || "Failed to confirm collection"
                );
              }

              // Close donor details modal
              donorDetailsModal.classList.add("hidden");

              // Redirect to rating page with donation ID
              window.location.href = `/rating.html?donationId=${donationId}`;
            } catch (error) {
              console.error("Collection confirmation error:", error);
              alert(
                error.message ||
                  "Failed to confirm collection. Please try again."
              );
            }
          };

          // Handle cancel collection
          document.getElementById("cancel-collection").onclick = () => {
            donorDetailsModal.classList.add("hidden");
          };
        } catch (error) {
          console.error("Donation details fetch error:", error);
          alert("Failed to fetch donation details. Please try again.");
        }
      }
    </script>
    <!-- Review Modal -->
    <div
      id="review-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50"
    >
      <div class="bg-white text-black rounded-lg p-6 w-full max-w-md shadow-xl">
        <h2 class="text-xl font-bold mb-4">Rate Your Experience</h2>

        <div class="flex justify-center space-x-2 mb-4">
          <button class="star-btn text-2xl" data-rating="1">‚≠ê</button>
          <button class="star-btn text-2xl" data-rating="2">‚≠ê</button>
          <button class="star-btn text-2xl" data-rating="3">‚≠ê</button>
          <button class="star-btn text-2xl" data-rating="4">‚≠ê</button>
          <button class="star-btn text-2xl" data-rating="5">‚≠ê</button>
        </div>

        <label class="block mb-2">Comments</label>
        <textarea
          id="review-comment"
          class="w-full border border-gray-300 rounded p-2 mb-4"
          rows="4"
          placeholder="Share your experience..."
        ></textarea>

        <div class="flex justify-end gap-2">
          <button
            id="cancel-review"
            class="px-4 py-2 rounded bg-gray-400 text-white"
          >
            Cancel
          </button>
          <button
            id="submit-review"
            class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
          >
            Submit
          </button>
        </div>
      </div>
    </div>
    <script>
      // Add event listeners for rating buttons
      document.querySelectorAll(".rating-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".rating-btn")
            .forEach((b) => b.classList.remove("selected"));
          btn.classList.add("selected");
        });
      });
    </script>
  </body>
</html>
